---
title: "LGBTQ+ Equality & Study Abroad"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    theme: united
---

```{r global, include=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(highcharter)
library(plotly)
library(ggrepel)
library(forcats)
library(shinydashboard)
library(sf)
library(rnaturalearth)
library(wbstats)
library(leaflet)
library(DT)
library(ggplot2)
library(readr)
studyabroad <- read_csv("studyabroad.csv")
```

About
==========================

Column {data-width = 400}
-------------------------



```{r  fig.width = 7, fig.height = 5, fig.align='center'}
include_graphics("HungaryPic.png") 
```

#### Authors

Siri Sagedahl and Cole Monson

#### The Story 

This past January, Cole and Siri went on a study abroad program to Budapest, Hungary. It was both of our first times studying abroad and it made us realize the complexities of traveling to another location for extended periods of time. Despite only living in Budapest for a month, the stark cultural differences were apparent in our daily lives. One of these differences between Minnesota and Budapest was the acceptance of LGBTQ+ identifying people. The conservative government limits general LGBTQ+ rights and the solitary social culture is far less accepting than the United States. As an LGBTQ+ identifying person, Siri had to look into this culture prior to traveling to Hungary. 

This project is a way to make this research more accessible to LGBTQ+ students looking to study abroad. Knowing how the new culture you're being immersed into sees your identity is very important for students' overall well being while away. **This app connects programs to indecies of LGBTQ+ acceptance levels, allowing students to explore the country's culture prior to committing to a program.**

The equality indices are ranged from 0 to 100 and are split into three main categories: **general, legal, and public opinion**. According to the equality index methodology, the "LGBT legal index measures the current legal status of 13 different issues ranging from the legal status of homosexuality, same-sex marriage, transgender rights, LGBT discrimination protections, LGBT censorship laws, and more. Each topic is weighted differently" based on its relative importance. The public opinion index "measures the public attitudes towards LGBT people using surveys and polls from reputable organizations. This index is scored based on averaging the results of all surveys in a given region." Additionally, the scores are weighted using a time-decay weighting method based on the date the survey was published. Finally, the equality index is the average of legal index and public opinion index.

Our final dataset, as displayed to the right, matches the location to these indices. Due to the fact that many programs visit more than one location within their time abroad, each observation represents a unique program-location pair.

#### Data Sources

+ Equality indices from [Equaldex](https://www.equaldex.com/equality-index) 
+ Study abroad information from [St. Olaf Smith Center](https://stolaf.studioabroad.com/index.cfm?FuseAction=Programs.SimpleSearch)

<center>

The following is an extensive table of the study abroad programs offered by the Smith Center:


```{r fig.width = 7, fig.height = 5, fig.align='center'}
renderTable({
  studyabroad |>
    select(program_name, city, country, equality_index, legal_index, public_opinion_index) |>
    rename(Program = program_name,
           City = city,
           Country = country,
           `General Equality Index` = equality_index,
           `Legal Index` = legal_index,
           `Public Opinion Index` = public_opinion_index)
})
```


Equality by Program
==========================

<<<<<<< HEAD
Column
-------------------------
```{r, echo=FALSE}
renderHighchart({
highchart() %>%
  hc_add_series_map(
    worldgeojson, studyabroad, value = "equality_index", joinBy = c('name','country'),
    name = "Equality Index"
    )  %>% 
  hc_colorAxis(stops = color_stops()) %>% 
  hc_title(text = "Equality Index in St. Olaf Study Abroad Programs") %>% 
  hc_subtitle(text = "St. Olaf Study Abroad Program Locations")
})
```


=======
```{r}
map <- ne_countries(returnclass = "sf")
names(map)[names(map) == "iso_a3"] <- "ISO3"
names(map)[names(map) == "name"] <- "NAME"
```

```{r}
map$equality_index <- studyabroad[match(map$NAME, studyabroad$country), ]$equality_index
```


<center>

### Study Abroad Opportunities for the 2024-2025 School Year


```{r}
pal <- colorBin(
  palette = "viridis", domain = map$equality_index,
  bins = seq(0, max(map$equality_index, na.rm = TRUE) + 10, by = 10)
)


map$labels <- paste0(
  "<strong> Country: </strong> ",
  map$NAME, "<br/> ",
  "<strong> Equality Index: </strong> ",
  map$equality_index, "<br/> "
) %>%
  lapply(htmltools::HTML)


mapFiltered <- reactive({
  rowsinrangeslider <- which(map$equality_index >= input$rangevalues[1] &
    map$equality_index <= input$rangevalues[2])
  map[rowsinrangeslider, ]
})

renderLeaflet({
  if (nrow(mapFiltered()) == 0) {
    return(NULL)
  }

  leaflet(mapFiltered()) %>%
    addTiles() %>%
    setView(lng = 0, lat = 30, zoom = 2) %>%
    addPolygons(
      fillColor = ~ pal(equality_index),
      #color = "white",
      weight = 2,
      fillOpacity = 0.7,
      label = ~labels,
      highlight = highlightOptions(
        color = "black",
        bringToFront = TRUE
      )
    ) %>%
    leaflet::addLegend(
      pal = pal, values = ~equality_index,
      opacity = 0.7, title = "Equality Index"
    )
})
```

```{r}
minvalue <- floor(min(map$equality_index, na.rm = TRUE))
maxvalue <- ceiling(max(map$equality_index, na.rm = TRUE))

sliderInput("rangevalues",
  label = "Equality Index Ratings:",
  min = minvalue, max = maxvalue,
  value = c(minvalue, maxvalue)
)
           
```

```{r, echo=FALSE}
#renderPlot({
#highchart() %>%
  #hc_add_series_map(
    #worldgeojson, studyabroad, value = "equality_index", joinBy = c('name','country'),
    #name = "Equality Index"
    #)  %>% 
  #hc_colorAxis(stops = color_stops()) %>% 
  #hc_title(text = "Equality Index in St. Olaf Study Abroad Programs") %>% 
  #hc_subtitle(text = "St. Olaf Study Abroad Program Locations")
#})
```
>>>>>>> 4bd8d860296041082c79db1aa63ff05c8f0da691


St. Olaf Study Abroad
==========================

Inputs {.sidebar}
-------------------------
```{r, echo=FALSE}
inputPanel(
  
  sliderInput("num_adjust", label = "Number of Countries:",
              min = 5, max = 20, value = 1, step = 1),
)

inputPanel(
    selectInput("subject", "Choose Subject:",
            choices = c("Math" = "math", 
                        "Natural Science" = "science", 
                        "Environmental Science" = "environment", 
                        "Art" = "art", 
                        "History" = "history", 
                        "Dance" = "dance", 
                        "Social Work" = "social work", 
                        "Classical Studies" = "classic", 
                        "Theater" = "theater", 
                        "Music" = "music", 
                        "Economomics" = "economics", 
                        "Education/Student Teaching" = "teaching"),
            selected = "science")
)
```


Column 
-------------------------

```{r, echo = FALSE}
renderPlot(studyabroad |>
  group_by(country) |>
  summarize(n = n()) |>
  mutate(country = fct_reorder(country, n)) |>
  slice_max(country, n = as.numeric(input$num_adjust)) |>
  ggplot(aes(x = country, y = n)) +
  geom_col(fill = "red") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "Country", y = "Num Occurrences", title = "Most Frequently Visited Destinations"))
```

```{r, echo = FALSE}
renderDataTable({
    studyabroad |>
    as_tibble() |>
      group_by(country) |>
      summarize(n = n()) |>
      mutate(country = fct_reorder(country, n)) |>
      slice_max(country, n = as.numeric(input$num_adjust)) |>
    rename(`Number of Programs` = n,
           Country = country)
})
```

```{r}
renderPlot({studyabroad |>
            filter(detected_subject == input$subject) |>
             group_by(country) |>
             summarize(n = n()) |>
             ggplot(aes(x = country, y = n)) +
             geom_col(fill = "skyblue") +
    labs(title = "Program Locations by Subject", x = "Country", y = "Number of Programs")
  })
```

Global Equality
==========================

Row {.tabset .tabset-fade}
-------------------------
### Equality Index

```{r, echo = FALSE}
renderPlot({
   average_equality <- studyabroad |>
      select(equality_cont) |>
      summarise(avg_equality = mean(equality_cont, na.rm = TRUE)) |>
      pull(avg_equality)
   
   studyabroad |>
      select(region, equality_cont, legal_cont, po_cont) |>
      group_by(region) |>
      mutate(region_id = row_number()) |>
      filter(region_id == 1) |>
  ggplot(aes(x = fct_reorder(region, equality_cont), y = equality_cont, fill = region)) +
  geom_col() +
  coord_flip() +
  geom_hline(yintercept = average_equality, linetype = "dashed", color = "skyblue", size = 1) +
     annotate("text", x = Inf, y = average_equality, label = "Global Average", vjust = -0.5, hjust = 1, color = "skyblue") +
      labs(x = "Continent", y = "Equality Index Value", 
           title = "Equality Index by Continent", fill = "Continent") +
      theme_minimal()
  })
```

### Legal Index

```{r}
renderPlot({
   studyabroad |>
      select(region, equality_cont, legal_cont, po_cont) |>
      group_by(region) |>
      mutate(region_id = row_number()) |>
      filter(region_id == 1) |>
    ggplot(aes(x = fct_reorder(region, legal_cont), y = legal_cont, fill = region)) +
  geom_col() +
    coord_flip() +
  labs(x = "Continent", y = "Legal Index Value", 
           title = "Legal Index by Continent", fill = "Continent") +
      theme_minimal()
})
```

### Public Opinion Index

```{r, echo = FALSE}
renderPlot({
   studyabroad |>
      select(region, equality_cont, legal_cont, po_cont) |>
      group_by(region) |>
      mutate(region_id = row_number()) |>
      filter(region_id == 1) |>
  ggplot(aes(x = fct_reorder(region, po_cont), y = po_cont, fill = region)) +
  geom_col() +
  coord_flip() +
      labs(x = "Continent", y = "Public Opinion Index Value", 
           title = "Public Opinion Index by Continent", fill = "Continent") +
      theme_minimal()
  })
```

Row
-------------------------
```{r, echo=FALSE}
selectInput("region", "Choose Continent:",
            choices = c("Africa", "Asia", "Europe", "North America", "Oceania", "South America"),
            multiple = TRUE,
            selected = "Africa")
```

```{r, echo = FALSE}
renderPlot({
  studyabroad |>
      group_by(country) |>
      mutate(country_id = row_number()) |>
      filter(country_id == 1,
             region %in% input$region) |>
    ggplot(aes(x = public_opinion_index, y = legal_index, label = country, color = region)) +
    geom_point() +
    geom_text_repel() +
    labs(title = "Study Abroad Location Public Opinion vs. Legal Index", x = "Public Opinion Index", y = "Legal Index", color = "Continent")
})
```

```{r}
valueBoxOutput("equalityGauge")
valueBoxOutput("legalGauge")
valueBoxOutput("poGauge")
```

```{r}
server <- function(input, output, session) {
  output$equalityGauge <- renderValueBox({
    avg_equality <- studyabroad |>
      summarize(avg_equality = mean(equality_cont, na.rm = TRUE)) |>
      pull(avg_equality)
    valueBox(value = round(avg_equality, 2), subtitle = "Global Average Equality Index")
  })
  
  output$legalGauge <- renderValueBox({
    avg_legal <- studyabroad |>
      summarize(avg_legal = mean(legal_cont, na.rm = TRUE)) |>
      pull(avg_legal)
    valueBox(value = round(avg_legal, 2), subtitle = "Global Average Legal Index")
  })
  
  output$poGauge <- renderValueBox({
    avg_po <- studyabroad |>
      summarize(avg_po = mean(po_cont, na.rm = TRUE)) |>
      pull(avg_po)
    valueBox(value = round(avg_po, 2), subtitle = "Global Average Public Opinion Index")
  })
}
shinyApp(ui = dashboardPage(
  dashboardHeader(disable = TRUE),
  dashboardSidebar(disable = TRUE),
  dashboardBody(fluidPage(
    uiOutput("equalityGauge"),
    uiOutput("legalGauge"),
    uiOutput("poGauge")
  ))
), server)
```




